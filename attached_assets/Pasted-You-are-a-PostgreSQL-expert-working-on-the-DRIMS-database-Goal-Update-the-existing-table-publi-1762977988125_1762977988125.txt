You are a PostgreSQL expert working on the DRIMS database.

Goal:
Update the existing table public."user" to fully support the Agency Account Creation workflow (US00.01.00), along with security and optimistic locking, without losing any existing data or breaking current constraints.

Requirements:
1. Retain all existing columns and data.
2. Add new fields only if they donâ€™t already exist.
3. Preserve all foreign key and unique constraints.
4. Add `agency_id` (link to agency table), `status_code`, `version_nbr`, and optional MFA + lockout fields.
5. Enable case-insensitive email comparison using citext.
6. Maintain safe, idempotent, re-runnable migration (no data loss).

Run the following SQL migration:
sql
Copy code
BEGIN;

-- Ensure citext extension for case-insensitive email
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_extension WHERE extname = 'citext') THEN
    CREATE EXTENSION citext;
  END IF;
END$$;

-- Add new columns if not present
ALTER TABLE public."user"
  ADD COLUMN IF NOT EXISTS username                varchar(60),
  ADD COLUMN IF NOT EXISTS password_algo           varchar(20) DEFAULT 'argon2id' NOT NULL,
  ADD COLUMN IF NOT EXISTS mfa_enabled             boolean DEFAULT false NOT NULL,
  ADD COLUMN IF NOT EXISTS mfa_secret              varchar(64),
  ADD COLUMN IF NOT EXISTS failed_login_count      smallint DEFAULT 0 NOT NULL,
  ADD COLUMN IF NOT EXISTS lock_until_at           timestamp(0) without time zone,
  ADD COLUMN IF NOT EXISTS password_changed_at     timestamp(0) without time zone,
  ADD COLUMN IF NOT EXISTS agency_id               integer,
  ADD COLUMN IF NOT EXISTS status_code             char(1) DEFAULT 'A' NOT NULL,  -- A=Active, I=Inactive, L=Locked
  ADD COLUMN IF NOT EXISTS version_nbr             integer;

-- Backfill optimistic lock field
UPDATE public."user" SET version_nbr = COALESCE(version_nbr, 1);
ALTER TABLE public."user" ALTER COLUMN version_nbr SET NOT NULL;

-- Status code constraint
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint
    WHERE conname = 'c_user_status_code'
      AND conrelid = 'public."user"'::regclass
  ) THEN
    ALTER TABLE public."user"
      ADD CONSTRAINT c_user_status_code CHECK (status_code IN ('A','I','L'));
  END IF;
END$$;

-- Add FK to agency (if missing)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint
    WHERE conname = 'user_agency_id_fkey'
      AND conrelid = 'public."user"'::regclass
  ) THEN
    ALTER TABLE public."user"
      ADD CONSTRAINT user_agency_id_fkey
      FOREIGN KEY (agency_id) REFERENCES public.agency(agency_id);
  END IF;
END$$;

COMMIT;

-- Indexes for performance
CREATE UNIQUE INDEX IF NOT EXISTS uk_user_username ON public."user"(username);
CREATE INDEX IF NOT EXISTS dk_user_agency_id ON public."user"(agency_id);

-- Optional: auto-update timestamp on write
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_proc WHERE proname='set_updated_at') THEN
    CREATE OR REPLACE FUNCTION set_updated_at() RETURNS trigger AS $f$
    BEGIN
      NEW.updated_at := CURRENT_TIMESTAMP;
      RETURN NEW;
    END; $f$ LANGUAGE plpgsql;
  END IF;
  IF NOT EXISTS (
    SELECT 1 FROM pg_trigger
    WHERE tgname='trg_user_set_updated_at'
      AND tgrelid='public."user"'::regclass
  ) THEN
    CREATE TRIGGER trg_user_set_updated_at
    BEFORE UPDATE ON public."user"
    FOR EACH ROW EXECUTE PROCEDURE set_updated_at();
  END IF;
END$$;