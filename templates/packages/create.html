{% extends 'base.html' %}

{% block title %}Create Relief Package{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col-12">
            <h2 class="text-goj-green"><i class="bi bi-plus-circle"></i> Create Relief Package</h2>
            <p class="text-muted">AIDMGMT Workflow - Step 2</p>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="POST" id="packageForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="reliefrqst_id" class="form-label">Approved Relief Request *</label>
                        <select class="form-select" id="reliefrqst_id" name="reliefrqst_id" required onchange="loadRequestItems()">
                            <option value="">Select request...</option>
                            {% for req in approved_requests %}
                            <option value="{{ req.reliefrqst_id }}" {% if selected_request and selected_request.reliefrqst_id == req.reliefrqst_id %}selected{% endif %}>
                                #{{ req.reliefrqst_id }} - {{ req.agency.agency_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Only approved or partially fulfilled requests</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="warehouse_id" class="form-label">Source Warehouse *</label>
                        <select class="form-select" id="warehouse_id" name="warehouse_id" required>
                            <option value="">Select warehouse...</option>
                            {% for warehouse in warehouses %}
                            <option value="{{ warehouse.warehouse_id }}">{{ warehouse.warehouse_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="start_date" class="form-label">Start Date *</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ today }}" max="{{ today }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="transport_mode" class="form-label">Transport Mode</label>
                        <select class="form-select" id="transport_mode" name="transport_mode">
                            <option value="">Select mode...</option>
                            <option value="TRUCK">Truck</option>
                            <option value="HELICOPTER">Helicopter</option>
                            <option value="BOAT">Boat</option>
                            <option value="HAND DELIVERY">Hand Delivery</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="comments_text" class="form-label">Comments</label>
                    <textarea class="form-control" id="comments_text" name="comments_text" rows="2" maxlength="255"></textarea>
                </div>

                <hr>
                <h5>Package Items</h5>
                <p class="text-muted">Items are loaded from the selected relief request. You can only package items that were requested.</p>
                
                {% if request_items %}
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Requested</th>
                                <th>Already Issued</th>
                                <th>Remaining</th>
                                <th>Package Quantity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rqst_item in request_items %}
                            {% set remaining = rqst_item.request_qty - rqst_item.issue_qty %}
                            {% if remaining > 0 %}
                            <tr>
                                <td>{{ rqst_item.item.item_name }}</td>
                                <td>{{ rqst_item.request_qty }}</td>
                                <td>{{ rqst_item.issue_qty }}</td>
                                <td><strong>{{ remaining }}</strong></td>
                                <td>
                                    <input type="hidden" name="rqst_item_id[]" value="{{ rqst_item.item_id }}">
                                    <input type="number" class="form-control" name="item_qty[]" 
                                           placeholder="0.00" step="0.01" min="0.01" max="{{ remaining }}" 
                                           value="{{ remaining }}">
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    Please select a relief request first. The form will reload to show the requested items.
                </div>
                {% endif %}

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-goj">Create Package</button>
                    <a href="{{ url_for('packages.list_packages') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function loadRequestItems() {
    const requestId = document.getElementById('reliefrqst_id').value;
    if (requestId) {
        window.location.href = '{{ url_for("packages.create_package") }}?request_id=' + requestId;
    }
}
</script>
{% endblock %}
